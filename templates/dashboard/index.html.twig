{% extends 'base.html.twig' %}

{# ── Twig macros ── #}
{% macro fmt(n) %}{{ n|number_format(0, ',', '.') }}{% endmacro %}
{% macro fmtPct(n) %}{{ n >= 0 ? '+' : '' }}{{ n|number_format(1) }}%{% endmacro %}
{% macro fmtEur(n) %}€{{ n|number_format(0, ',', '.') }}{% endmacro %}

{% macro miniBar(value, max, color) %}
{% set pct = ((value|abs) / max * 100)|round %}
{% if pct > 100 %}{% set pct = 100 %}{% endif %}
<div class="mini-bar">
    <div class="mini-bar__fill" style="width: {{ pct }}%; background: {{ color }};"></div>
</div>
{% endmacro %}

{% macro miniBarBand(value, max, color, bandLow, bandHigh) %}
{% set pct = ((value|abs) / max * 100)|round %}
{% if pct > 100 %}{% set pct = 100 %}{% endif %}
<div class="mini-bar">
    <div class="mini-bar__band" style="left: {{ (bandLow / max * 100)|round }}%; width: {{ ((bandHigh - bandLow) / max * 100)|round }}%;"></div>
    <div class="mini-bar__fill" style="width: {{ pct }}%; background: {{ color }};"></div>
</div>
{% endmacro %}

{% macro signalDot(status) %}
{% if status == 'red' %}<span class="dot dot--red"></span>
{% elseif status == 'yellow' %}<span class="dot dot--yellow"></span>
{% elseif status == 'green' %}<span class="dot dot--green"></span>
{% else %}<span class="dot dot--gray"></span>{% endif %}
{% endmacro %}

{% macro statusBadge(status) %}
{% if status == 'OK' %}<span class="badge badge--green">OK</span>
{% elseif status == 'PENDING' %}<span class="badge badge--blue">PENDING</span>
{% elseif status == 'MONITOR' %}<span class="badge badge--yellow">MONITOR</span>
{% elseif status == 'REBAL' %}<span class="badge badge--red">REBAL</span>
{% elseif status == 'ONTBREEKT' %}<span class="badge badge--red">ONTBREEKT</span>
{% endif %}
{% endmacro %}

{% block body %}
{# ── Alerts ── #}
{% if ib_error and not ib_from_buffer|default(false) %}<div class="alert alert--warning">Interactive Brokers data is momenteel niet beschikbaar.</div>{% endif %}
{% if saxo_error and not saxo_from_buffer|default(false) %}<div class="alert alert--warning">Saxo Bank data kon niet worden opgehaald.</div>{% endif %}
{% if macro_error %}<div class="alert alert--warning">Macro indicatoren konden niet worden geladen.</div>{% endif %}

{# ── Buffered data banners ── #}
{% if saxo_from_buffer|default(false) %}
<div class="alert alert--buffered">
    <span class="dot dot--yellow"></span>
    Saxo data van {{ saxo_buffered_at }} (gebufferd)
    {% if not saxo_authenticated %} — <a href="{{ path('saxo_login') }}">Token vernieuwen</a>{% endif %}
</div>
{% endif %}
{% if ib_from_buffer|default(false) %}
<div class="alert alert--buffered">
    <span class="dot dot--yellow"></span>
    IB data van {{ ib_buffered_at }} (gebufferd)
</div>
{% endif %}

{# ── Set crisis signal colors ── #}
{% set dd = crisis.drawdown.drawdown_pct ?? 0 %}
{% set vixVal = macro.vix ?? 0 %}
{% set hyBps = macro.hy_spread_bps ?? 0 %}
{% set priceColor = dd <= -20 ? 'red' : (dd <= -10 ? 'yellow' : 'green') %}
{% set vixColor = vixVal >= 30 ? 'red' : (vixVal >= 20 ? 'yellow' : 'green') %}
{% set creditColor = hyBps >= 500 ? 'red' : (hyBps >= 400 ? 'yellow' : 'green') %}
{% set crisisCount = crisis.active_signals ?? 0 %}

{# ── HEADER ── #}
<div class="header">
    <h1 class="header__title">MIDO Command Center</h1>
    <div class="header__meta">
        <p class="header__sub">Strategie v8.0 — {{ "now"|date("d M Y H:i") }}
            <span class="text-muted" style="font-size: 10px; margin-left: 8px;">
                IB: {{ ib_data_timestamp ?? 'n/a' }}{% if ib_from_buffer|default(false) %} (buffer){% endif %}
                | Saxo: {{ saxo_data_timestamp ?? 'n/a' }}{% if saxo_from_buffer|default(false) %} (buffer){% endif %}
            </span>
        </p>
        <div class="header__badges">
            {% if crisisCount == 0 %}
                <span class="badge badge--green">GEEN ACTIE</span>
            {% elseif crisisCount == 1 %}
                <span class="badge badge--yellow">NIVEAU 1</span>
            {% elseif crisisCount == 2 %}
                <span class="badge badge--red">NIVEAU 2</span>
            {% else %}
                <span class="badge badge--red">NIVEAU 2+</span>
            {% endif %}
            {% if not saxo_authenticated %}
                <a href="{{ path('saxo_login') }}" class="btn btn--primary">Saxo Inloggen</a>
            {% else %}
                <span class="badge badge--green">Saxo verbonden</span>
            {% endif %}
        </div>
    </div>
</div>

{# ── TAB NAV ── #}
<div data-controller="tabs">
    <div class="tabs">
        <button class="tab active" data-tabs-target="tab" data-tab="overview" data-action="click->tabs#switch">Overzicht</button>
        <button class="tab" data-tabs-target="tab" data-tab="positions" data-action="click->tabs#switch">Posities</button>
        <button class="tab" data-tabs-target="tab" data-tab="crisis" data-action="click->tabs#switch">Crisis</button>
        <button class="tab" data-tabs-target="tab" data-tab="factors" data-action="click->tabs#switch">Factoren</button>
        <button class="tab" data-tabs-target="tab" data-tab="momentum" data-action="click->tabs#switch">Momentum</button>
        <button class="tab" data-tabs-target="tab" data-tab="history" data-action="click->tabs#switch">Historie</button>
    </div>

    {# ── TOP METRICS ROW ── #}
    <div class="grid grid--5 mb-20">
        <div class="glass stat">
            <div class="stat__label">Totaal Vermogen</div>
            <div class="stat__value mono">{{ _self.fmtEur(allocation.total_portfolio) }}</div>
            <div class="stat__sub">P/L: {{ _self.fmtPct(allocation.total_invested > allocation.total_pl ? (allocation.total_pl / (allocation.total_invested - allocation.total_pl)) * 100 : 0) }}</div>
        </div>
        {% set eq = allocation.asset_classes.equity ?? {} %}
        <div class="glass stat">
            <div class="stat__label">Equity</div>
            <div class="stat__value {{ eq.in_band ?? true ? 'text-green' : 'text-yellow' }}">{{ (eq.current_pct ?? 0)|number_format(1) }}%</div>
            <div class="stat__sub {{ eq.in_band ?? true ? 'text-green' : 'text-yellow' }}">Target: {{ eq.target ?? 75 }}% | {{ eq.in_band ?? true ? '✓ In band' : '⚠ Buiten band' }}</div>
        </div>
        {% set fi = allocation.asset_classes.fixed_income ?? {} %}
        <div class="glass stat">
            <div class="stat__label">Vastrentend</div>
            <div class="stat__value {{ fi.in_band ?? true ? 'text-green' : 'text-yellow' }}">{{ (fi.current_pct ?? 0)|number_format(1) }}%</div>
            <div class="stat__sub {{ fi.in_band ?? true ? 'text-green' : 'text-yellow' }}">Target: {{ fi.target ?? 15 }}% | {{ fi.in_band ?? true ? '✓ In band' : '⚠ Buiten band' }}</div>
        </div>
        <div class="glass stat">
            <div class="stat__label">Dry Powder</div>
            <div class="stat__value mono">{{ _self.fmtEur(allocation.dry_powder) }}</div>
            <div class="stat__sub">Crisis Niv.1: {{ _self.fmtEur(25000) }}</div>
        </div>
        <div class="glass stat">
            <div class="stat__label">Regime</div>
            <div class="stat__value text-green">{{ regime }}</div>
            <div class="stat__sub">VIX: {{ (macro.vix ?? 0)|number_format(1) }} | CAPE: {{ (macro.cape ?? 0)|number_format(0) }}</div>
        </div>
    </div>

    {# ════════════════════════════════════════════════════════════════
       TAB: OVERZICHT
       ════════════════════════════════════════════════════════════════ #}
    <div class="tab-panel active" data-tabs-target="panel" data-panel="overview">
        <div class="grid grid--2">
            {# ── Asset Class vs Target ── #}
            <div class="glass">
                <div class="section-label"><span class="section-label__text">Asset Class vs Target</span></div>
                <div class="flex gap-20">
                    <div class="chart-wrap chart-wrap--pie">
                        {{ render_chart(pie_chart) }}
                    </div>
                    <div class="flex-1">
                        {% set acColors = { equity: '#22c55e', fixed_income: '#3b82f6', alternatives: '#f59e0b' } %}
                        {% for key, ac in allocation.asset_classes %}
                        <div class="mb-14">
                            <div class="flex-between" style="font-size: 12px; margin-bottom: 4px;">
                                <span style="color: {{ acColors[key] }};" class="fw-600">{{ ac.label }}</span>
                                <span>
                                    <span class="text-dim fw-700">{{ ac.current_pct|number_format(1) }}%</span>
                                    <span class="text-muted"> / {{ ac.target }}%</span>
                                    <span style="margin-left: 6px; font-size: 11px;" class="{{ ac.in_band ? 'text-green' : 'text-yellow' }}">
                                        {{ ac.drift >= 0 ? '+' : '' }}{{ ac.drift|number_format(1) }}pp
                                    </span>
                                </span>
                            </div>
                            {{ _self.miniBarBand(ac.current_pct, 100, acColors[key], ac.band_low, ac.band_high) }}
                        </div>
                        {% endfor %}
                        <div>
                            <div class="flex-between" style="font-size: 12px; margin-bottom: 4px;">
                                <span style="color: #475569;" class="fw-600">Cash (niet belegd)</span>
                                <span class="text-dim fw-700">{{ allocation.cash_pct|number_format(1) }}%</span>
                            </div>
                            {{ _self.miniBar(allocation.cash_pct, 100, '#475569') }}
                        </div>
                    </div>
                </div>
            </div>

            {# ── Crisis Protocol ── #}
            <div class="glass {{ crisisCount > 0 ? 'glass--red' : 'glass--green' }}">
                <div class="section-label"><span class="section-label__text">Crisis Protocol v8.0</span></div>
                <div class="grid grid--3 mb-16">
                    {% set signals = [
                        { label: 'PRIJS', sub: 'IWDA ' ~ (dd|number_format(1)) ~ '%', trigger: '< -20%', color: priceColor },
                        { label: 'VIX', sub: (vixVal|number_format(1)), trigger: '> 30 (3d)', color: vixColor },
                        { label: 'CREDIT', sub: 'HY ' ~ hyBps ~ 'bps', trigger: '> 500bps', color: creditColor },
                    ] %}
                    {% for s in signals %}
                    <div class="signal-card signal-card--{{ s.color }}">
                        {{ _self.signalDot(s.color) }}
                        <div style="font-size: 11px; font-weight: 700; letter-spacing: 1.5px; color: var(--text-label); margin-top: 6px;">{{ s.label }}</div>
                        <div style="font-size: 18px; font-weight: 800; margin-top: 2px;">{{ s.sub }}</div>
                        <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">Trigger: {{ s.trigger }}</div>
                    </div>
                    {% endfor %}
                </div>
                <div class="inner-panel">
                    <div style="font-size: 11px; font-weight: 700; color: var(--text-label); margin-bottom: 8px; letter-spacing: 1px;">
                        DEPLOYMENT PROTOCOL
                        {% if crisisCount == 0 %}
                            <span class="text-green" style="font-weight: 600; letter-spacing: 0;">— Geen actie nodig</span>
                        {% else %}
                            <span class="text-red" style="font-weight: 600; letter-spacing: 0;">— ACTIE VEREIST</span>
                        {% endif %}
                    </div>
                    {% set ddCheck = dd <= -15 %}
                    {% set level1Active = crisisCount >= 1 and ddCheck %}
                    {% set level2Active = crisisCount >= 2 %}
                    {% set levels = [
                        { level: 1, active: level1Active, condition: '1/3 signalen + DD>15%', amount: 25000, source: 'XEON',
                          action: 'Verkoop €25.000 XEON → koop AVWC + AVWS pro rata' },
                        { level: 2, active: level2Active, condition: '2/3 signalen', amount: 45000, source: 'XEON + IBGS',
                          action: 'Verkoop €45.000 (XEON rest + IBGS) → koop AVWC + NT World (Saxo)' },
                        { level: 3, active: false, condition: '30d: 2/3 nog actief', amount: 45000, source: 'IBGS',
                          action: 'Verkoop €45.000 IBGS → koop NT World + NT EM (Saxo FBI)' },
                        { level: 4, active: false, condition: '30d: 3/3 (systeem)', amount: 0, source: 'IBGS volledig',
                          action: 'Restant IBGS volledig naar equity' },
                    ] %}
                    {% for dp in levels %}
                    <div class="deploy-step {{ dp.active ? 'deploy-step--active' : 'deploy-step--inactive' }}">
                        <span class="deploy-step__num">{{ dp.level }}</span>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 11px; color: var(--text-label);">{{ dp.condition }}</div>
                            {% if dp.active %}
                            <div style="font-size: 10px; color: var(--green); margin-top: 2px; font-weight: 600;">→ {{ dp.action }}</div>
                            {% endif %}
                        </div>
                        <span style="font-size: 11px; font-weight: 700; flex-shrink: 0; color: {{ dp.active ? 'var(--red)' : 'var(--text-muted)' }};">
                            {{ dp.amount > 0 ? _self.fmtEur(dp.amount) : 'Restant' }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {# ── Macro Indicatoren ── #}
            <div class="glass">
                <div class="section-label"><span class="section-label__text">Macro Indicatoren</span></div>
                <div class="grid grid--2" style="gap: 10px;">
                    {% set macroItems = [
                        { label: 'ECB Rente', value: macro.ecb_rate is not null ? macro.ecb_rate|number_format(2) ~ '%' : '...', color: '#3b82f6' },
                        { label: 'EU Inflatie', value: macro.eu_inflation is not null ? macro.eu_inflation|number_format(1) ~ '%' : '...', color: '#f59e0b' },
                        { label: 'CAPE S&P', value: macro.cape is not null ? macro.cape|number_format(0) ~ 'x' : '...', color: (macro.cape ?? 0) > 35 ? '#ef4444' : '#22c55e' },
                        { label: 'Goud USD', value: macro.gold is not null ? '$' ~ macro.gold|number_format(0) : '...', color: '#f59e0b' },
                        { label: 'EUR/USD', value: macro.eurusd is not null ? macro.eurusd|number_format(3) : '...', color: '#8b5cf6' },
                        { label: 'US 10Y', value: macro.dgs10 is not null ? macro.dgs10|number_format(2) ~ '%' : '...', color: '#06b6d4' },
                    ] %}
                    {% for m in macroItems %}
                    <div class="inner-panel">
                        <div style="font-size: 10px; color: var(--text-muted); font-weight: 600; letter-spacing: 1px;">{{ m.label }}</div>
                        <div style="font-size: 20px; font-weight: 800; color: {{ m.color }}; margin-top: 2px;" class="mono">{{ m.value }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            {# ── Herbalancering 5/25 Regel ── #}
            {% set rebalCount = allocation.rebal_needed|length %}
            <div class="glass {{ rebalCount > 0 ? 'glass--yellow' : 'glass--green' }}">
                <div class="section-label"><span class="section-label__text">Herbalancering 5/25 Regel</span></div>
                {% if rebalCount > 0 %}
                <div style="font-size: 13px; font-weight: 600; margin-bottom: 12px;" class="text-yellow">
                    ⚠ {{ rebalCount }} positie(s) buiten 5/25 band
                </div>
                {% else %}
                <div style="font-size: 13px; font-weight: 600; margin-bottom: 12px;" class="text-green">
                    ✓ Alle posities binnen band
                </div>
                {% endif %}

                <div style="font-size: 10px; font-weight: 700; color: var(--text-muted); letter-spacing: 1.5px; margin-bottom: 8px;">V8.0 POSITIES</div>
                {% for name, p in positions_by_drift %}
                {% if p.target > 0 %}
                <div class="pos-row">
                    <span class="pos-row__name {{ p.status == 'ONTBREEKT' ? 'text-muted' : 'text-label' }}">{{ name }}</span>
                    <span class="pos-row__pct mono fw-700">{{ p.current_pct|number_format(1) }}%</span>
                    <span class="pos-row__target text-muted">/ {{ p.target }}%</span>
                    {% set absDrift = p.drift|abs %}
                    <span class="pos-row__drift fw-700 {{ absDrift >= 5 ? 'text-red' : (absDrift >= 3 ? 'text-yellow' : 'text-green') }}">
                        {{ p.drift >= 0 ? '+' : '' }}{{ p.drift|number_format(1) }}pp
                    </span>
                    <span class="pos-row__badge">{{ _self.statusBadge(p.status) }}</span>
                </div>
                {% endif %}
                {% endfor %}
                {# Legacy posities (target 0%, nog in portefeuille) #}
                {% set hasLegacy = false %}
                {% for name, p in allocation.positions %}
                    {% if p.target == 0 and p.value > 0 %}
                        {% if not hasLegacy %}
                            <div style="font-size: 10px; font-weight: 700; color: var(--text-muted); letter-spacing: 1.5px; margin: 12px 0 8px;">LEGACY (VERKOPEN)</div>
                            {% set hasLegacy = true %}
                        {% endif %}
                        <div class="pos-row" style="opacity: 0.6;">
                            <span class="pos-row__name text-muted">{{ name }}</span>
                            <span class="pos-row__pct mono fw-600 text-muted">{{ p.current_pct|number_format(1) }}%</span>
                            <span class="pos-row__target text-muted">{{ _self.fmtEur(p.value) }}</span>
                            <span class="pos-row__drift"></span>
                            <span class="pos-row__badge"><span class="badge badge--yellow" style="font-size: 9px;">SELL</span></span>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        {# ── Saxo Open Orders ── #}
        {% if saxo_open_orders is defined and saxo_open_orders|length > 0 %}
        {% set totalOrderValue = 0 %}
        {% for order in saxo_open_orders %}
            {% set totalOrderValue = totalOrderValue + (order.order_value ?? 0) %}
        {% endfor %}
        <div class="glass glass--yellow mt-16">
            <div class="section-label"><span class="section-label__text">Open Orders (Saxo)</span></div>
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">
                {{ saxo_open_orders|length }} openstaande order(s){% if totalOrderValue > 0 %} — totaal {{ _self.fmtEur(totalOrderValue) }} (onderdeel van Saxo cash){% endif %}
            </div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Instrument</th>
                            <th>Richting</th>
                            <th style="text-align:right;">Waarde</th>
                            <th>Type</th>
                            <th style="text-align:right;">Prijs</th>
                            <th>Duur</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in saxo_open_orders %}
                        <tr>
                            <td>
                                <span class="fw-600">{{ order.symbol }}</span>
                                {% if order.description %}<span class="text-muted" style="font-size:11px;"> — {{ order.description }}</span>{% endif %}
                            </td>
                            <td>
                                <span class="badge badge--{{ order.buy_sell == 'Buy' ? 'green' : 'red' }}" style="font-size:10px;">
                                    {{ order.buy_sell }}
                                </span>
                            </td>
                            <td style="text-align:right;" class="mono">{{ (order.order_value ?? 0) > 0 ? _self.fmtEur(order.order_value) : '—' }}</td>
                            <td class="text-muted">{{ order.order_type }}</td>
                            <td style="text-align:right;" class="mono">{{ order.price > 0 ? order.price|number_format(2, ',', '.') : 'Market' }}</td>
                            <td class="text-muted">{{ order.duration }}</td>
                            <td><span class="badge badge--yellow" style="font-size:10px;">{{ order.status }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    {# ════════════════════════════════════════════════════════════════
       TAB: POSITIES
       ════════════════════════════════════════════════════════════════ #}
    <div class="tab-panel" data-tabs-target="panel" data-panel="positions">
        <div class="glass mb-16">
            <div class="section-label"><span class="section-label__text">Alle Posities vs v8.0 Targets</span></div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Positie</th>
                            <th>Platform</th>
                            <th class="text-right">Waarde</th>
                            <th class="text-right">Huidig %</th>
                            <th class="text-right">Target %</th>
                            <th class="text-right">Drift</th>
                            <th class="text-right">P/L</th>
                            <th class="text-right">P/L %</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for name, p in allocation.positions %}
                        <tr style="{{ p.status == 'ONTBREEKT' ? 'opacity: 0.5;' : '' }}">
                            <td class="fw-600">
                                <span class="ac-dot ac-dot--{{ p.asset_class }}"></span>{{ name }}
                            </td>
                            <td>
                                <span class="badge {{ p.platform == 'Saxo' ? 'badge--purple' : 'badge--blue' }}">{{ p.platform }}</span>
                            </td>
                            <td class="text-right fw-600 mono">{{ _self.fmtEur(p.value) }}</td>
                            <td class="text-right fw-700 mono">{{ p.current_pct|number_format(1) }}%</td>
                            <td class="text-right text-muted">{{ p.target }}%</td>
                            {% set driftColor = p.drift|abs >= 5 ? 'text-red' : (p.drift|abs >= 3 ? 'text-yellow' : 'text-green') %}
                            <td class="text-right fw-700 {{ driftColor }}">{{ p.drift >= 0 ? '+' : '' }}{{ p.drift|number_format(1) }}pp</td>
                            {% set plColor = p.pl >= 0 ? 'text-green' : 'text-red' %}
                            <td class="text-right {{ plColor }} fw-600 mono">{{ p.pl >= 0 ? '+' : '' }}{{ _self.fmtEur(p.pl) }}</td>
                            <td class="text-right {{ plColor }} fw-600 mono">{{ _self.fmtPct(p.pl_pct) }}</td>
                            <td>{{ _self.statusBadge(p.status) }}</td>
                        </tr>
                        {% endfor %}
                        {# Cash row #}
                        {% set ordersTotal = 0 %}
                        {% if saxo_open_orders is defined %}
                            {% for o in saxo_open_orders %}
                                {% set ordersTotal = ordersTotal + (o.order_value ?? 0) %}
                            {% endfor %}
                        {% endif %}
                        <tr style="border-top: 2px solid rgba(148,163,184,0.15);">
                            <td class="fw-600 text-muted">Cash (niet belegd)</td>
                            <td><span class="text-muted" style="font-size: 10px;">IB+Saxo</span></td>
                            <td class="text-right fw-600 mono">{{ _self.fmtEur(allocation.total_cash) }}</td>
                            <td class="text-right fw-700 mono">{{ allocation.cash_pct|number_format(1) }}%</td>
                            <td colspan="5" class="text-muted" style="font-size: 11px;">
                                IB: {{ _self.fmtEur(allocation.ib_cash) }} | Saxo: {{ _self.fmtEur(allocation.saxo_cash) }}{% if ordersTotal > 0 %} (wv. {{ _self.fmtEur(ordersTotal) }} in open orders){% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="grid grid--2">
            {# Platform Verdeling #}
            <div class="glass">
                <div class="section-label"><span class="section-label__text">Platform Verdeling</span></div>
                {% if allocation.platform_split.saxo == 0 and saxo_authenticated %}
                    <div style="background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 6px; padding: 6px 10px; margin-bottom: 10px; font-size: 11px; color: #f59e0b;">
                        Saxo data ontbreekt — totalen zijn onvolledig
                    </div>
                {% endif %}
                {% set ibPct = allocation.total_portfolio > 0 ? (allocation.platform_split.ibkr / allocation.total_portfolio * 100) : 0 %}
                {% set saxoPct = allocation.total_portfolio > 0 ? (allocation.platform_split.saxo / allocation.total_portfolio * 100) : 0 %}
                <div class="mb-14">
                    <div class="flex-between" style="font-size: 12px; margin-bottom: 4px;">
                        <span class="text-blue fw-600">Interactive Brokers</span>
                        <span><span class="fw-700">{{ _self.fmtEur(allocation.platform_split.ibkr) }}</span> <span class="text-muted">({{ ibPct|number_format(0) }}%)</span></span>
                    </div>
                    {{ _self.miniBar(ibPct, 100, '#3b82f6') }}
                </div>
                <div>
                    <div class="flex-between" style="font-size: 12px; margin-bottom: 4px;">
                        <span class="text-purple fw-600">Saxo Bank</span>
                        <span><span class="fw-700">{{ _self.fmtEur(allocation.platform_split.saxo) }}</span> <span class="text-muted">({{ saxoPct|number_format(0) }}%)</span></span>
                    </div>
                    {{ _self.miniBar(saxoPct, 100, '#8b5cf6') }}
                </div>
            </div>

            {# Geografische Verdeling (geschat) #}
            <div class="glass">
                <div class="section-label"><span class="section-label__text">Geografische Verdeling (geschat)</span></div>
                {% set geoColors = ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6'] %}
                {% set geoEstimates = { US: 38, Europa: 28, 'Japan/Pacific': 5, EM: 12, Alternatives: 12 } %}
                {% set geoTargets = { US: 40, Europa: 18, 'Japan/Pacific': 7, EM: 20, Alternatives: 15 } %}
                {% set i = 0 %}
                {% for geo, target in geoTargets %}
                    {% set current = geoEstimates[geo] ?? 0 %}
                    {% set drift = current - target %}
                    <div class="flex items-center gap-10" style="padding: 6px 0;">
                        <span style="font-size: 12px; width: 90px;" class="text-label fw-500">{{ geo }}</span>
                        <div class="flex-1">{{ _self.miniBar(current, 70, geoColors[i]) }}</div>
                        <span style="font-size: 12px; width: 35px; text-align: right;" class="fw-700">{{ current }}%</span>
                        <span style="font-size: 11px; width: 30px; text-align: right;" class="text-muted">{{ target }}%</span>
                        <span style="font-size: 11px; width: 40px; text-align: right;" class="fw-600 {{ drift|abs > 5 ? 'text-yellow' : 'text-muted' }}">
                            {{ drift >= 0 ? '+' : '' }}{{ drift }}pp
                        </span>
                    </div>
                    {% set i = i + 1 %}
                {% endfor %}
            </div>
        </div>
    </div>

    {# ════════════════════════════════════════════════════════════════
       TAB: CRISIS
       ════════════════════════════════════════════════════════════════ #}
    <div class="tab-panel" data-tabs-target="panel" data-panel="crisis">
        <div class="grid grid--2">
            {# Drawdown Monitor (full width) #}
            <div class="glass grid--full">
                <div class="section-label"><span class="section-label__text">Crisis Drawdown Monitor</span></div>
                <div class="grid grid--4">
                    <div class="inner-panel--big">
                        <div class="stat__label">IWDA vs 52W High</div>
                        <div style="font-size: 36px; font-weight: 800; margin-top: 8px;">{{ (dd)|number_format(1) }}%</div>
                        <div style="font-size: 11px; margin-top: 4px;" class="text-muted">Trigger: &lt; -20%</div>
                    </div>
                    <div class="inner-panel--big">
                        <div class="stat__label">VIX Niveau</div>
                        <div style="font-size: 36px; font-weight: 800; margin-top: 8px;">{{ vixVal|number_format(1) }}</div>
                        <div style="font-size: 11px; margin-top: 4px;" class="text-muted">Trigger: &gt; 30</div>
                    </div>
                    <div class="inner-panel--big">
                        <div class="stat__label">HY Spread</div>
                        <div style="font-size: 36px; font-weight: 800; margin-top: 8px;">{{ hyBps }}bps</div>
                        <div style="font-size: 11px; margin-top: 4px;" class="text-muted">Trigger: &gt; 500bps</div>
                    </div>
                    <div class="inner-panel--big" style="{{ crisisCount > 0 ? 'border-color: rgba(239,68,68,0.3);' : '' }}">
                        <div class="stat__label">Actieve Signalen</div>
                        <div style="font-size: 36px; font-weight: 800; margin-top: 8px;" class="{{ crisisCount == 0 ? 'text-green' : 'text-red' }}">{{ crisisCount }}/3</div>
                    </div>
                </div>
            </div>

            {# Dry Powder Inventaris #}
            <div class="glass">
                <div class="section-label"><span class="section-label__text">Dry Powder Inventaris</span></div>
                <div class="mb-20">
                    <div style="font-size: 28px; font-weight: 800;">{{ _self.fmtEur(allocation.dry_powder) }}</div>
                    <div style="font-size: 12px; margin-top: 4px;" class="text-muted">Beschikbaar voor crisis deployment</div>
                </div>
                {% set dpItems = [
                    { label: 'XEON (puur dry powder)', value: allocation.positions.XEON.value ?? 0, color: '#3b82f6' },
                    { label: 'IBGS (flight-to-safety)', value: allocation.positions.IBGS.value ?? 0, color: '#06b6d4' },
                    { label: 'ERNX (yield capture)', value: allocation.positions.ERNX.value ?? 0, color: '#8b5cf6' },
                    { label: 'Cash IB + Saxo', value: allocation.total_cash, color: '#475569' },
                ] %}
                {% for dp in dpItems %}
                <div class="flex-between" style="padding: 8px 0; border-bottom: 1px solid rgba(148,163,184,0.06);">
                    <span style="font-size: 12px; color: {{ dp.color }};" class="fw-500">
                        <span style="display: inline-block; width: 8px; height: 8px; border-radius: 2px; background: {{ dp.color }}; margin-right: 8px;"></span>{{ dp.label }}
                    </span>
                    <span style="font-size: 12px;" class="fw-700 mono">{{ _self.fmtEur(dp.value) }}</span>
                </div>
                {% endfor %}
                {% if saxo_cash_for_trading|default(0) > 0 %}
                <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid rgba(148,163,184,0.12);">
                    <div class="flex-between" style="padding: 4px 0;">
                        <span style="font-size: 11px;" class="text-muted">Saxo vrij voor trading</span>
                        <span style="font-size: 11px;" class="fw-700 mono">{{ _self.fmtEur(saxo_cash_for_trading) }}</span>
                    </div>
                    {% if saxo_cost_to_close|default(0) != 0 %}
                    <div class="flex-between" style="padding: 4px 0;">
                        <span style="font-size: 11px;" class="text-muted">Kosten sluiten posities</span>
                        <span style="font-size: 11px;" class="fw-700 mono text-red">{{ _self.fmtEur(saxo_cost_to_close) }}</span>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            {# Valuta Exposure (Saxo) #}
            {% if saxo_currency_exposure|default([])|length > 0 %}
            <div class="glass">
                <div class="section-label"><span class="section-label__text">Valuta Exposure (Saxo)</span></div>
                {% set totalExposure = 0 %}
                {% for exp in saxo_currency_exposure %}
                    {% set totalExposure = totalExposure + exp.amount_base|abs %}
                {% endfor %}
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align: left;">Valuta</th>
                                <th style="text-align: right;">Exposure</th>
                                <th style="text-align: right;">In EUR</th>
                                <th style="text-align: right;">% Totaal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for exp in saxo_currency_exposure %}
                            <tr>
                                <td class="fw-500">{{ exp.currency }}</td>
                                <td style="text-align: right;" class="mono">{{ exp.amount|number_format(0, ',', '.') }}</td>
                                <td style="text-align: right;" class="mono">{{ _self.fmtEur(exp.amount_base) }}</td>
                                <td style="text-align: right;" class="mono">{{ totalExposure > 0 ? ((exp.amount_base|abs / totalExposure) * 100)|number_format(1) : '0.0' }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            {# 5 Vragen #}
            <div class="glass">
                <div class="section-label"><span class="section-label__text">5 Vragen Om NIET Te Verkopen</span></div>
                {% for q in five_questions %}
                <div class="question">
                    <span class="question__num">{{ loop.index }}</span>
                    <span style="font-size: 12px; line-height: 1.5;" class="text-label">{{ q }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {# ════════════════════════════════════════════════════════════════
       TAB: FACTOREN
       ════════════════════════════════════════════════════════════════ #}
    <div class="tab-panel" data-tabs-target="panel" data-panel="factors">
        <div class="grid grid--2">
            {# Radar Chart #}
            <div class="glass">
                <div class="section-label"><span class="section-label__text">Factor Exposure v8.0</span></div>
                <div class="chart-wrap chart-wrap--h280">
                    {{ render_chart(radar_chart) }}
                </div>
            </div>

            {# Factor Scores Detail #}
            <div class="glass">
                <div class="section-label"><span class="section-label__text">Factor Scores Detail</span></div>
                {% set fColors = ['#3b82f6', '#22c55e', '#f59e0b', '#8b5cf6', '#06b6d4'] %}
                {% for f in factors %}
                <div class="mb-16">
                    <div class="flex-between mb-4">
                        <span style="font-size: 13px; color: {{ fColors[loop.index0] }};" class="fw-600">{{ f.factor }}</span>
                        <span style="font-size: 13px;" class="fw-800">{{ (f.score * 100)|number_format(0) }}%</span>
                    </div>
                    <div class="factor-bar">
                        <div class="factor-bar__fill" style="width: {{ (f.score / 0.6 * 100)|number_format(0) }}%; background: linear-gradient(90deg, {{ fColors[loop.index0] }}88, {{ fColors[loop.index0] }});"></div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {# Factor Mapping #}
            <div class="glass">
                <div class="section-label"><span class="section-label__text">Positie → Factor Mapping</span></div>
                {% for m in factor_mapping %}
                <div style="padding: 10px 0; border-bottom: 1px solid rgba(148,163,184,0.06);">
                    <div class="fw-700 mb-4">{{ m.position }}</div>
                    <div class="flex gap-4 mb-2">
                        {% for f in m.factors %}
                        <span class="badge badge--blue" style="font-size: 10px;">{{ f }}</span>
                        {% endfor %}
                    </div>
                    <div style="font-size: 11px;" class="text-muted">{{ m.description }}</div>
                </div>
                {% endfor %}
            </div>

            {# Performance Chart #}
            <div class="glass">
                <div class="section-label"><span class="section-label__text">Performance per Positie</span></div>
                <div class="chart-wrap chart-wrap--h280">
                    {{ render_chart(performance_chart) }}
                </div>
            </div>
        </div>
    </div>

    {# ════════════════════════════════════════════════════════════════
       TAB: MOMENTUM
       ════════════════════════════════════════════════════════════════ #}
    <div class="tab-panel" data-tabs-target="panel" data-panel="momentum">
        {% if momentum_error %}
        <div class="alert alert--warning">Momentum data kon niet worden geladen.</div>
        {% endif %}

        <div class="grid grid--2">
            {# Regime Signal #}
            <div class="glass {{ signal.regime.bull ? 'glass--green' : 'glass--red' }}">
                <div class="section-label"><span class="section-label__text">Regime Signaal</span></div>
                <div class="inner-panel--big mb-16">
                    <div class="stat__label">IWDA vs MA200</div>
                    <div style="font-size: 42px; font-weight: 800; margin-top: 8px;" class="{{ signal.regime.bull ? 'text-green' : 'text-red' }}">
                        {{ signal.regime.bull ? 'BULL' : 'BEAR' }}
                    </div>
                    <div style="font-size: 13px; margin-top: 8px;" class="text-muted">
                        Prijs: <span class="mono fw-700 text-dim">{{ signal.regime.price|number_format(2) }}</span>
                        &nbsp;|&nbsp;
                        MA200: <span class="mono fw-700 text-dim">{{ signal.regime.ma200|number_format(2) }}</span>
                    </div>
                    {% set diff = signal.regime.price - signal.regime.ma200 %}
                    {% set diffPct = signal.regime.ma200 > 0 ? (diff / signal.regime.ma200 * 100) : 0 %}
                    <div style="font-size: 12px; margin-top: 4px;">
                        <span class="{{ diff >= 0 ? 'text-green' : 'text-red' }} fw-700">
                            {{ diff >= 0 ? '+' : '' }}{{ diffPct|number_format(1) }}% {{ diff >= 0 ? 'boven' : 'onder' }} MA200
                        </span>
                    </div>
                </div>
                <div class="inner-panel">
                    <div style="font-size: 11px; font-weight: 700; color: var(--text-label); margin-bottom: 6px; letter-spacing: 1px;">STRATEGIE</div>
                    <div style="font-size: 12px; line-height: 1.6;" class="text-label">{{ signal.reason }}</div>
                </div>
            </div>

            {# Momentum Allocatie #}
            <div class="glass">
                <div class="section-label"><span class="section-label__text">Momentum Allocatie</span></div>
                {% for ticker, weight in signal.allocation %}
                <div class="flex-between" style="padding: 10px 0; border-bottom: 1px solid rgba(148,163,184,0.06);">
                    <div>
                        <span class="fw-700" style="font-size: 14px;">{{ ticker }}</span>
                        {% if signal.scores[ticker] is defined %}
                        <span class="text-muted" style="font-size: 11px; margin-left: 6px;">{{ signal.scores[ticker].name }}</span>
                        {% endif %}
                    </div>
                    <div class="flex items-center gap-12">
                        <div style="width: 120px;">
                            {{ _self.miniBar(weight * 100, 100, weight >= 0.5 ? '#22c55e' : '#3b82f6') }}
                        </div>
                        <span class="mono fw-800" style="font-size: 16px; width: 50px; text-align: right;">{{ (weight * 100)|number_format(0) }}%</span>
                    </div>
                </div>
                {% endfor %}
            </div>

            {# Momentum Scores Tabel #}
            <div class="glass grid--full">
                <div class="section-label"><span class="section-label__text">ETF Momentum Scores (12-1 maand)</span></div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ticker</th>
                                <th>Naam</th>
                                <th>Rol</th>
                                <th class="text-right">Score</th>
                                <th class="text-right">Prijs</th>
                                <th>Allocatie</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set rank = 1 %}
                            {% for ticker, s in signal.scores %}
                            {% set inAlloc = signal.allocation[ticker] is defined %}
                            <tr style="{{ s.cash ? 'opacity: 0.5;' : '' }}{{ inAlloc ? 'background: rgba(34,197,94,0.04);' : '' }}">
                                <td class="text-muted">{{ rank }}</td>
                                <td class="fw-700 mono">{{ ticker }}</td>
                                <td>{{ s.name }}</td>
                                <td class="text-muted" style="font-size: 11px;">{{ s.role }}</td>
                                <td class="text-right">
                                    {% if s.score <= -999 %}
                                        <span class="text-muted">n/a</span>
                                    {% else %}
                                        <span class="mono fw-700 {{ s.score > 0 ? 'text-green' : 'text-red' }}">{{ s.score|number_format(3) }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-right mono">{{ s.last_price|number_format(2) }}</td>
                                <td>
                                    {% if inAlloc %}
                                        <span class="badge badge--green">{{ (signal.allocation[ticker] * 100)|number_format(0) }}%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% set rank = rank + 1 %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 12px; font-size: 11px;" class="text-muted">
                    Score = risico-gecorrigeerd momentum (12 maanden return excl. laatste maand / volatiliteit).
                    XEON uitgesloten van ranking (cash equivalent). Bull/bear regime op basis van IWDA vs 200-daags gemiddelde.
                </div>
            </div>
        </div>
    </div>

    {# ════════════════════════════════════════════════════════════════
       TAB 6: HISTORIE
       ════════════════════════════════════════════════════════════════ #}
    <div class="tab-panel" data-tabs-target="panel" data-panel="history">
        {% set r = returns|default({}) %}

        {# ── Portfolio Rendement stat cards ── #}
        {% if r.net_deposits|default(0) > 0 %}
        <div class="grid grid--5 mb-20">
            <div class="glass stat">
                <div class="stat__label">Totaal Gestort</div>
                <div class="stat__value mono">{{ _self.fmtEur(r.total_deposits) }}</div>
                <div class="stat__sub">Netto: {{ _self.fmtEur(r.net_deposits) }}</div>
            </div>
            <div class="glass stat">
                <div class="stat__label">Huidige Waarde</div>
                <div class="stat__value mono">{{ _self.fmtEur(r.current_value) }}</div>
            </div>
            <div class="glass stat">
                <div class="stat__label">Rendement</div>
                <div class="stat__value mono {{ r.total_return >= 0 ? 'text-green' : 'text-red' }}">{{ r.total_return >= 0 ? '+' : '' }}{{ _self.fmtEur(r.total_return) }}</div>
                <div class="stat__sub {{ r.total_return_pct >= 0 ? 'text-green' : 'text-red' }}">{{ _self.fmtPct(r.total_return_pct) }}</div>
            </div>
            <div class="glass stat">
                <div class="stat__label">Dividend</div>
                <div class="stat__value mono text-green">{{ _self.fmtEur(r.total_dividends) }}</div>
                <div class="stat__sub">Rente: {{ _self.fmtEur(r.total_interest) }}</div>
            </div>
            <div class="glass stat">
                <div class="stat__label">Commissie</div>
                <div class="stat__value mono text-red">{{ _self.fmtEur(r.total_commission) }}</div>
            </div>
        </div>
        {% endif %}

        {# ── Saxo Performance Metrics ── #}
        {% if r.saxo_twr|default(null) is not null %}
        <div class="grid grid--4 mb-20">
            <div class="glass stat">
                <div class="stat__label">TWR (Saxo)</div>
                <div class="stat__value mono {{ r.saxo_twr >= 0 ? 'text-green' : 'text-red' }}">{{ r.saxo_twr >= 0 ? '+' : '' }}{{ (r.saxo_twr * 100)|number_format(2) }}%</div>
                <div class="stat__sub">Time-Weighted Return</div>
            </div>
            <div class="glass stat">
                <div class="stat__label">Sharpe Ratio</div>
                <div class="stat__value mono {{ r.saxo_sharpe >= 1 ? 'text-green' : (r.saxo_sharpe >= 0.5 ? 'text-yellow' : 'text-red') }}">{{ r.saxo_sharpe|number_format(2) }}</div>
                <div class="stat__sub">{{ r.saxo_sharpe >= 1 ? 'Goed' : (r.saxo_sharpe >= 0.5 ? 'Matig' : 'Laag') }}</div>
            </div>
            <div class="glass stat">
                <div class="stat__label">Sortino Ratio</div>
                <div class="stat__value mono {{ r.saxo_sortino >= 1 ? 'text-green' : (r.saxo_sortino >= 0.5 ? 'text-yellow' : 'text-red') }}">{{ r.saxo_sortino|number_format(2) }}</div>
                <div class="stat__sub">Downside risk-adjusted</div>
            </div>
            <div class="glass stat">
                <div class="stat__label">Max Drawdown</div>
                <div class="stat__value mono text-red">{{ (r.saxo_max_drawdown * 100)|number_format(1) }}%</div>
                <div class="stat__sub">Maximale daling</div>
            </div>
        </div>
        {% endif %}

        {# ── Per-positie rendement tabel ── #}
        {% if position_returns|default([])|length > 0 %}
        <div class="glass">
            <div class="section-label"><span class="section-label__text">Rendement per Positie</span></div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th style="text-align: left;">Positie</th>
                            <th style="text-align: right;">Gekocht</th>
                            <th style="text-align: right;">Verkocht</th>
                            <th style="text-align: right;">Huidig</th>
                            <th style="text-align: right;">Unrealized P/L</th>
                            <th style="text-align: right;">Dividend</th>
                            <th style="text-align: right;">Totaal Return</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pos in position_returns %}
                        <tr>
                            <td>{{ pos.name }}{% if pos.source|default('transactions') == 'live' %} <span class="text-muted" style="font-size: 10px;" title="Cost basis afgeleid van live P/L (geen transactiedata)">*</span>{% endif %}</td>
                            <td style="text-align: right;" class="mono">{{ _self.fmtEur(pos.total_bought) }}</td>
                            <td style="text-align: right;" class="mono">{{ pos.total_sold > 0 ? _self.fmtEur(pos.total_sold) : '-' }}</td>
                            <td style="text-align: right;" class="mono">{{ pos.current_value > 0 ? _self.fmtEur(pos.current_value) : '-' }}</td>
                            <td style="text-align: right;" class="mono {{ pos.unrealized_pl >= 0 ? 'text-green' : 'text-red' }}">{{ pos.unrealized_pl != 0 ? (pos.unrealized_pl >= 0 ? '+' : '') ~ _self.fmtEur(pos.unrealized_pl) : '-' }}</td>
                            <td style="text-align: right;" class="mono {{ pos.dividends > 0 ? 'text-green' : '' }}">{{ pos.dividends > 0 ? _self.fmtEur(pos.dividends) : '-' }}</td>
                            <td style="text-align: right;" class="mono {{ pos.total_return >= 0 ? 'text-green' : 'text-red' }}">{{ pos.total_return >= 0 ? '+' : '' }}{{ _self.fmtEur(pos.total_return) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        {# ── Transactieoverzicht per maand ── #}
        {% if monthly_overview.combined|default([])|length > 0 %}
        <div class="glass mt-16">
            <div class="section-label"><span class="section-label__text">Transacties per Maand</span></div>
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <button class="btn btn--sm btn--active" onclick="showTxTab('tx-combined', this)">Totaal</button>
                <button class="btn btn--sm" onclick="showTxTab('tx-ib', this)">IBKR{% if monthly_overview.ib|length > 0 %} ({{ monthly_overview.ib|length }}){% endif %}</button>
                <button class="btn btn--sm" onclick="showTxTab('tx-saxo', this)">Saxo{% if monthly_overview.saxo|length > 0 %} ({{ monthly_overview.saxo|length }}){% endif %}</button>
            </div>
            {% macro txTable(rows) %}
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th style="text-align: left;">Maand</th>
                            <th style="text-align: right;">Stortingen</th>
                            <th style="text-align: right;">Kopen</th>
                            <th style="text-align: right;">Verkopen</th>
                            <th style="text-align: right;">Dividend</th>
                            <th style="text-align: right;">Commissie</th>
                            <th style="text-align: right;">Rente</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in rows %}
                        <tr>
                            <td>{{ row.month }}</td>
                            <td style="text-align: right;" class="mono">{{ row.deposits > 0 ? _self.fmtEur(row.deposits) : '-' }}</td>
                            <td style="text-align: right;" class="mono">{{ row.buys > 0 ? _self.fmtEur(row.buys) : '-' }}</td>
                            <td style="text-align: right;" class="mono">{{ row.sells > 0 ? _self.fmtEur(row.sells) : '-' }}</td>
                            <td style="text-align: right;" class="mono {{ row.dividends > 0 ? 'text-green' : '' }}">{{ row.dividends > 0 ? _self.fmtEur(row.dividends) : '-' }}</td>
                            <td style="text-align: right;" class="mono text-red">{{ row.commissions > 0 ? _self.fmtEur(row.commissions) : '-' }}</td>
                            <td style="text-align: right;" class="mono">{{ row.interest > 0 ? _self.fmtEur(row.interest) : '-' }}</td>
                        </tr>
                        {% endfor %}
                        {% if rows|length == 0 %}
                        <tr><td colspan="7" class="text-muted" style="text-align: center;">Geen transacties</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            {% endmacro %}
            <div id="tx-combined">{{ _self.txTable(monthly_overview.combined) }}</div>
            <div id="tx-ib" style="display: none;">{{ _self.txTable(monthly_overview.ib) }}</div>
            <div id="tx-saxo" style="display: none;">{{ _self.txTable(monthly_overview.saxo) }}</div>
        </div>
        <script>
        function showTxTab(id, btn) {
            document.querySelectorAll('[id^="tx-"]').forEach(function(el) { el.style.display = 'none'; });
            document.getElementById(id).style.display = '';
            btn.parentElement.querySelectorAll('.btn').forEach(function(b) { b.classList.remove('btn--active'); });
            btn.classList.add('btn--active');
        }
        </script>
        {% endif %}

        {# ── Portfolio waarde chart (als er snapshots zijn) ── #}
        {% if history|default([])|length > 1 and history_chart is defined and history_chart is not null %}
        <div class="grid grid--2 mt-16">
            <div class="glass">
                <div class="section-label"><span class="section-label__text">Portfolio Waarde</span></div>
                <div class="chart-wrap chart-wrap--h280">
                    {{ render_chart(history_chart) }}
                </div>
            </div>
            {% if allocation_chart is defined and allocation_chart is not null %}
            <div class="glass">
                <div class="section-label"><span class="section-label__text">Asset Allocatie</span></div>
                <div class="chart-wrap chart-wrap--h280">
                    {{ render_chart(allocation_chart) }}
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if r.net_deposits|default(0) == 0 and history|default([])|length <= 1 %}
        <div class="glass">
            <div style="text-align: center; padding: 40px; color: #94a3b8;">
                Nog geen transactiedata beschikbaar. Importeer transacties via <code>app:transactions:import</code>.
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
